%%%
title = "OpenID for Verifiable Presentations over BLE"
abbrev = "opendi4vp-offline"
ipr = "none"
workgroup = "OpenID Connect"
keyword = ["security", "openid", "ssi"]

[seriesInfo]
name = "Internet-Draft"
value = "openid-for-verifiable-presentations-offline-1_0-01"
status = "standard"

[[author]]
initials="K."
surname="Yasuda"
fullname="Kristina Yasuda"
organization="Microsoft"
    [author.address]
    email = "kristina.yasuda@microsoft.com"
%%%

.# Abstract

This document defines how Bluetooth Low Energy (BLE) can be used to request presentation of a verifiable credential. It uses request and response syntax defined in [@!OpenID4VP] specification.

{mainmatter}

# Introduction

This document enables Wallets and the Verifiers who have implemented [@!OpnID4VP] to be able to request and receive verifiable presentations even when one or both of the entities do not have Internet connection.

The document defines how Bluetooth Low Energy (BLE) can be used to request presentation of a verifiable credential.It uses request and response syntax defined in [@!OpenID4VP] specification.

# Terms and Definitions

verifiable credential
wallet
the Verifier

//WIP

ToDo: "Connection" or "Session"?

# Use Cases

## Use Case when only wallet is offline

## Use Case when only the Verifier is offline

## Use Case when both wallet and the Verifier are offline

# Scope

//WIP

# Overview

Wallet and the Verifier MUST implement BLE according to the [Bluetooth Core Specification 4.0](https://www.bluetooth.com/specifications/specs/core-specification-4-0/). 

Wallet and the Verifier MUST support LE Data Packet Length Extension.

ToDo: For the wallet, mDL mandates 4.0, and recommends 4.2. and LE data Pathet Length Extension. For the reader, 4.2 and LE Data Packet Length Extension is mandated and 5.0 and LE 2M PHY is recommended.

The protocol consists of the following two steps:

1. Establishing a connection
2. Exchanging verifiable credentials

During step 1, ephemeral keys to encrypt the session are exchanged. 

Step 2 utilizes request and response syntax defined in [@!OpenID4VP] specification. Response type `vp_token` MUST be used to obtain the VP Token in Authorization Response.

# Protocol Flow

~~~ ascii-art
+----------+                                         +----------------+
|          |                                         |                |
|          |<---- (1) Connection setup request ------|                |
|          |          using QR code                  |                |
|          |                                         |                |
|          |----- (2) OpenID4VP Request over BLE --->|                |
|          |                                         |                |
|          |       +----------+                      |                |
|          |       |          |                      |                |
|          |       | End-User |                      |                |
| Verifier |       |          |<--(2) AuthN & AuthZ->|     Wallet     |
|          |       |          |                      |                |
|          |       +----------+                      |                |
|          |                                         |                |
|          |<---- (3) OpenID4VP Response over BLE ---|                |
|          |      (verifiable presentation)          |                |
|          |                                         |                |
+----------+                                         +----------------+
~~~
Figure: OpenID4VP over BLE Protocol Flow


## Connection Setup

Wallet and the Verifier MUST support the Central role. The Wallet MUST act as GATT client. 

ToDo: name this as central client mode..?

The Wallet MUST display to the Verifier a QR code the contains base64url-encoded Connection Setup Request with the following parameters:

* `curves`
    * REQUIRED. 9.1.5.2.
    identifier of the Elliptic Curve to be used for key agreement
* `ephemeral_Verifier_pub_key`
    * REQUIRED. A JSON object that is an ephemeral public key generated by the Wallet for session encryption. The key is a bare key in JWK [@!RFC7517] format (not an X.509 certificate value).
* `data_presentation_method`
    * REQUIRED. MUST be `ble`.
* `uuid_client_central_mode`
    * REQUIRED. UUID for the client central mode?

ToDo: passing `ephemeral_Verifier_pub_key` in JSON in the QR code might be too big?
ToDo: check what cipher suites define.
ToDo: `data_presentation_method` as placeholders for how the Verifier know this is the request for the OpenID4VP over BLE. Might consider other mechanisms.
ToDo: omitted parameter - version of the specification supported
ToDo: Can `data_presentation_method` be `HTTP` if the wallet wants to fallback to usual OpenID4VP?

Below is a non-normative example of a Connection Setup request (with line wraps within values for display purposes only):

```
  openid://?
    cipher_s=openid%20profile
    &response_type=id_token
    &client_id=did%3Aexample%3AEiDrihTRe0GMdc3K16kgJB3Xbl9Hb8oqVHjzm6ufHcYDGA
    &redirect_uri=https%3A%2F%2Fclient.example.org%2Fcb
    &claims=...
    &registration=%7B%22subject_syntax_types_supported%22%3A
    %5B%22did%3Aexample%22%5D%2C%0A%20%20%20%20
    %22id_token_signing_alg_values_supported%22%3A%5B%22ES256%22%5D%7D
    &nonce=n-0S6_WzA2Mj
```

8.3.3.1.1.2

How the Connection Setup Request reaches a Wallet of a user's choice that capable of handling the request is out of scope of this specification(i.e. the usage of the Custom URL Schemes, Claimed URLs, etc.). See Chapter 7 of [@!SIOPv2] for some recommendations.

Connection Setup Request MUST be base64url-encoded without padding as defined in [@!RFC4648], as path

ToDo: check what ", as path" means.

# Session Encryption

1. The Wallet generates an ephemeral key pair and in the Connection Setup Request sends to the Verifier the ephemeral public key and the identifier of the elliptic curve.
2. The Verifier generates an ephemeral key pair using the elliptic curve received in the Connection Setup Request. 
3. The Verifier derives a session key using the Wallet's public key received in the Connection Setup Request, and encrypts OpenID4VP Request using it.
4. The Verifier sends an encrypted OpenID4VP Request to the Verifier that contains Verifier's ephemeral public key.
5. The Wallet derives a session key using the Verifier's public key received in the OpenID4VP Request, and encrypts OpenID4VP Response using it.
6. The Verifier decrypts OpenID4VP Response using the session key computed in step 3.

# Session Termination

The session MUST be terminated if at least one of the following conditions occur: 
* After a time-out of no activity occurs. 
* If the Wallet does not want to receive any further requests. 
* If the Verifier does not want to send any further requests. 

A Wallet or Verifier has two options to send the termination message: 
* To send the status code for session termination. 
* To send the "End" command defined in Clause 8.3.3.1.1.5 

If the intent to terminate the session is received, the Wallet and Verifier shall perform at least the following actions: 
* Destruction of session keys and related ephemeral key material 
* Closure of the communication channel used for data retrieval.

ToDo: Clean-up the language so that less ISOy.

# OpenID4VP 

## OpenID4VP Request

This document extends [@!OpenID4VP] specification with the following parameters:

`ephemeral_Verifier_pub_key`: REQUIRED. A JSON object that is an ephemeral public key generated by the Verifier for session encryption. The key is a bare key in JWK [@!RFC7517] format (not an X.509 certificate value).


For the BLE device retrieval    transmission    technology, the contents    of  the Alternative Carrier Record and Carrier  Configuration   Record(s) shall comply  with    Clause 8.3.3.1.1.2. 


The	UUID’s in the BleOptions structure shall be encoded using variant 1 (‘10x’b) as specified in RFC 4122.

Which one is better...

The UUID for peripheral server mode must be present if Wallet peripheral server mode is supported and must not be present if peripheral server mode is not supported.

The UUID for client central mode must be present if Wallet central client mode is supported and must not be present if central client mode is not supported.

The UUID’s used shall be 16-byte UUID’s that are unique for the transaction. The Peripheral device shall broadcast the service with the UUID as received during device engagement in the advertising packet. The Central device is then able to scan for the UUID and connect to the advertised service. However, the Central device may use a different mechanisms to identify the Peripheral device.

NOTE 1 BLE stacks in mobile devices can use scan filter and caching methods to manage congested environments and manage scan intervals for device energy consumption control. This can influence the connection time required when using UUIDs for the identification of the Peripheral device. 

NOTE 2 Finding the correct device to connect to is purely a practical problem. Connecting to the wrong Verifier does not have security implications, since due to the security methods described in Clause 9, the Wallet and Verifier will not setup a session with the wrong Verifier. Note however, that these mechanisms do not provide complete protection against a bad actor aiming to cause a denial of service attack by advertising as a fake Verifier

To ensure that the Wallet is connected to the correct Verifier. The Wallet may verify the Ident characteristic as described in Clause 8.3.3.1.4. The Ident characteristic value shall be calculated using the following procedure: 

Use HKDF an defined in RFC 5869 with the following parameters: 
• Hash: SHA-256 
• IKM: EdeviceKeyBytes (see Clause 9.1.1.4) 
• salt: (no salt value is provided) 
• info:”BLEIdent” (encoded as ASCII string) 
• L: 16 octets 
If the Ident characteristic received from the Verifier does not match the expected value, the Wallet shall disconnect from the Verifier. 

NOTE 3 The purpose of the Ident characteristic is only to verify whether the Wallet is connected to the correct Verifier before setting starting data retrieval. If the Wallet is connected to the wrong Verifier, session establishment will fail. Connecting and disconnecting to an Verifier takes a relatively large amount of time and it is therefore fastest to implement methods to identify the correct Verifier to connect to and not to rely purely on the Ident characteristic to identify the correct Verifier. 

After connection is setup, the GATT client may check to see if the GATT server supports the L2CAP transmission profile and, if so, use it to transfer data. See Annex A for more information. If the L2CAP transmission profile is used, Clause 8.3.3.1.1.5, Clause 8.3.3.1.1.6, Clause 8.3.3.1.1.7 and Clause 8.3.3.1.1.8 do not apply


## Security Considerations

## Session Information

Both wallet and the Verifier MUST remove all the information about the session after its termination.

## Discussion points
 
- not requiring nor recommending BLE secure connections.
- no support for the Peropheral role.
- did not define a custom URL scheme that can open any compliant wallet.
